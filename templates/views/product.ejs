<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../partials/head.ejs') %>
        <title>Products - The Basic Co.</title>
</head>

<body>
    <%- include('../partials/navbar.ejs') %>
        <div class="container mx-auto flex flex-col sm:flex-row">
            <% console.log(product.title) %>
                <div class="flex-center flex-col mb-4 min-h-screen sm:w-96 mr-4">
                    <img class="my-4 main_image sm:h-8/12" src="/images/model.jpg" alt="product">
                    <div class="w-9/12 h-16 flex-center overflow-x-scroll slide-wrapper">
                        <img class="max-h-16 mx-2 slide-img" src="/images/model.jpg" alt="product image">
                        <img class="max-h-16 mx-2 slide-img" src="/images/gift.png" alt="product image">
                        <img class="max-h-16 mx-2 slide-img" src="/images/search.png" alt="product image">
                    </div>
                </div>

                <div class="sm:w-3/5 flex items-start flex-col">
                    <div class="w-full px-4 mt-6">
                        <h1 class="font-bold text-xl capitalize">
                            <%= product.title %>
                        </h1>
                        <p class=" text-gray-600 text-sm mt-4 capitalize">
                            <%= product.desc %>
                        </p>
                        <span class="font-bold text-orange-500 text-xl my-4 block">&#8377;<%= product.price %></span>
                    </div>

                    <div class="w-full px-4">
                        <span class="text-gray-600 font-bold text-sm block mb-2 mt-8">Select a Color</span>
                        <div class="flex-center block py-2 w-full">

                            <% product.variants.colors.map((color)=> { %>
                                <input value="<%= color %>" class="w-10 h-10 mr-4 color_badge cursor-pointer"
                                    type="radio" name="color" id="<%= color %>">
                                <% }) %>
                        </div>

                        <span class="text-gray-600 font-bold text-sm block mb-2 mt-8">Select a Size</span>
                        <div class="w-full flex py-2">

                            <select name="size" id="size" class="w-40 shadow-xl h-10 bg-orange-50 font-bold">
                                <% product.variants.sizes && product.variants.sizes.map((size)=> { %>
                                    <option value="<%= size %>">
                                        <%= size %>
                                    </option>
                                    <% }) %>
                            </select>
                        </div>
                    </div>
                    <div class="flex-center px-2 my-8">
                        <button id="add_to_cart_btn" data-product="<%= product._id %>" data-price="<%= product.price %>"
                            class="flex-1 mr-4 w-64 font-bold bg-orange-400 hover:bg-orange-500 h-12">ADD TO
                            CART</button>
                    </div>
                </div>

        </div>

        <script>
            const slides = document.querySelectorAll('.slide-img')
            const main_image = document.querySelector('.main_image')

            slides.forEach((slide) => {

                slide.addEventListener('click', () => {

                    let secSrc = slide.getAttribute('src')
                    main_image.setAttribute('src', secSrc)
                })
            })

            const addToCartBtn = document.querySelector('#add_to_cart_btn')
            addToCartBtn.addEventListener('click', async (e) => {
                e.preventDefault()

                const productId = addToCartBtn.dataset.product
                const productPrice = addToCartBtn.dataset.price
                const colors = document.getElementsByName('color')
                let color


                for (let i = 0; i < colors.length; i++) {
                    if (colors[i].checked) {
                        color = colors[i].value
                    }
                }

                //cart = {items: {_id: {color, size, qty}}, _id: {color, size, qty}}, totalQty, totalPrice}

                const cart = window.localStorage.getItem('cart')
                let _cart = cart

                if (!cart || cart == null) {
                    _cart = {
                        items: {},
                        totalQty: 0
                    }
                }
                else {
                    _cart = JSON.parse(cart)
                }
                console.log(_cart);

                if (!_cart.items[productId] || !_cart.items[productId].color === color || !_cart.items[productId].size === document.querySelector('#size').value) {
                    _cart.items[productId] = {
                        size: document
                            .querySelector('#size')
                            .value,
                        color: color,
                        qty: 1
                    }
                    _cart.totalQty += 1
                }
                else {
                    _cart.items[productId].qty += 1
                    _cart.totalQty += 1
                }

                window.localStorage.setItem('cart', JSON.stringify(_cart))
                alert('added')
            })
        </script>
</body>

</html>